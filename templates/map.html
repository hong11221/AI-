<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Ï∂îÏ≤ú Í≤ΩÎ°ú ÏßÄÎèÑ</title>

  <!-- ‚úÖ Kakao ÏßÄÎèÑ SDK autoload=true Î°ú ÏÑ§Ï†ï -->
  <script type="text/javascript" 
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5213faf6f38ce579f8ebad9bb28a1725&autoload=true&libraries=services">
  </script>

  <style>
    #map {
      width: 100%;
      height: 600px;
    }
  </style>
</head>

<body>
  <h2 style="margin:10px;">{{ place }} Ï£ºÎ≥Ä Ï∂îÏ≤ú Í≤ΩÎ°ú</h2>
  <div id="map"></div>

  <script>
    window.onload = function () {
      const mapContainer = document.getElementById('map');
      const mapOption = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 5
      };
      const map = new kakao.maps.Map(mapContainer, mapOption);
      const geocoder = new kakao.maps.services.Geocoder();

      const routes = {{ routes | tojson }};
      console.log("üß≠ Ï†ÑÎã¨Î∞õÏùÄ routes:", routes);

      const colorList = ['#007aff', '#ff3b30', '#34c759', '#ff9500', '#8e8e93'];

      routes.forEach((routeObj, routeIndex) => {
        const route = routeObj.route;
        const user = routeObj.user;
        const coords = [];
        const strokeColor = colorList[routeIndex % colorList.length];

        const processPoint = (index) => {
          if (index >= route.length) {
            if (coords.length >= 2) {
              const polyline = new kakao.maps.Polyline({
                path: coords,
                strokeWeight: 4,
                strokeColor: strokeColor,
                strokeOpacity: 0.8,
                strokeStyle: 'solid'
              });
              polyline.setMap(map);
            }
            return;
          }

          geocoder.addressSearch(route[index], (result, status) => {
            if (status === kakao.maps.services.Status.OK) {
              const latlng = new kakao.maps.LatLng(result[0].y, result[0].x);
              coords.push(latlng);

              new kakao.maps.Marker({ map: map, position: latlng });

              new kakao.maps.CustomOverlay({
                map: map,
                position: latlng,
                content: `<div style="background:#fff;border:2px solid ${strokeColor};border-radius:50%;padding:4px;font-size:12px;text-align:center;width:20px;height:20px;line-height:12px;">${index + 1}</div>`,
                yAnchor: 1
              });
            } else {
              console.warn("‚ùå Î≥ÄÌôò Ïã§Ìå®:", route[index]);
            }

            setTimeout(() => {
              processPoint(index + 1);
            }, 100);
          });
        };

        processPoint(0);
      });
    };
  </script>
</body>
</html>
